<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style/game.css">
    <script type="text/javascript" src="js/question.js"></script>
    <title>Games</title>
</head>

<body class="gametype_00">
    <div id="container" class="home">
        <div id="home" class="flex-c">
            <h1 id="game_name">比手</br>畫腳</h1>
            <div class="time_btns flex-c">
                <div class="time_btn flex-c"></div>
                <div class="time_btn flex-c active"></div>
                <div class="time_btn flex-c"></div>
                <div class="time_btn flex-c"></div>
                <div class="time_btn flex-c"></div>
            </div>
            <div class="Qlist_btns flex-c">
                <div class="Qlist_btn flex-c">Default</div>
                <div class="Qlist_btn flex-c">Film AFI</div>
                <div class="Qlist_btn flex-c">Taiwan Food</div>
                <div class="Qlist_btn flex-c">JP Drama</div>
                <div class="Qlist_btn flex-c">ATENer</div>
            </div>
            <div class="question_input_box">
                <div class="input_btn block">Upload file</div>
                <input type="file" id="fileInput">
            </div>
            <p>Please upload .txt and a line is a question</p>
        </div>
        <div class="question_box flex-c">
            <div id="question"></div>
            <div id="timer" class="flex-c"></div>
            <div class="next_box flex-c">
                <a href="#" class="next_btn flex-c">close</a>
                <a href="#" class="next_btn flex-c">done</a>
            </div>
            <div id="answer_count"></div>
        </div>
        <div id="home_btn" class="flex-c">home</div>
        <div id="swich_btn" class="flex-c">compare_arrows</div>
        <div id="screen_click"></div>
        <p id="hotkey"></p>
    </div>
    <audio id="bgm01" src="music/bgm_BrandNewToy.mp3"></audio>
    <audio id="bgm02" src="music/bgm_cut-to-the-chase.mp3"></audio>
</body>
<script>


    // ******************************
    // 
    //      Random question 
    //      - QintoHTML()
    //      - fileInput.Listener
    //
    // ******************************

    var Qlist = [];
    var Qlisting = [];
    var Qlisting_len = 0;

    Qlist = Qlist_0_00     // 輸入預設問題
    Qlisting = Qlist       // 輸入執行遊戲的問題集


    // 建立隨機題號
    var Qlisting_len = Qlisting.length;
    function getRandom() {
        Qlisting_len = Qlisting.length;
        return Math.floor(Math.random() * Qlisting_len);
    }
    var num = getRandom();


    // 取得隨機題目,印 入HTML 後,刪除該題目
    var questionBox = document.getElementById("question")
    function QintoHTML() {
        Qlisting_len = Qlisting.length;
        if (Qlisting_len == 1) {
            questionBox.innerHTML = "It's over";
        }
        else {
            num = getRandom();
            questionBox.innerHTML = Qlisting[num];
            Qlisting = Qlisting.filter((element, index) => index != num);
        }
    }





    // 切換題組
    function changeQList(QlistName) {
        Qlist = QlistName
        Qlisting = Qlist
        QintoHTML()
    }


    // 問題檔案輸入
    function selectedFileChanged() {
        if (this.files.length === 0) {
            console.log('請選擇檔案！');
            return;
        }
        const reader = new FileReader();
        reader.onload = function fileReadCompleted() {
            // 檔案問題分割 → 重新計算題目數 → 輸出題目
            console.log(reader.result);
            Qlist = reader.result.split("\n");
            Qlist_len = Qlist.length;
            QintoHTML()
        };
        reader.readAsText(this.files[0]);
    }


    document.getElementById('fileInput').addEventListener('change', selectedFileChanged);





    // ******************************
    //
    // 
    //      計時器
    //      - timerStart()
    //      - timerStop()
    //
    //
    //
    //
    // ******************************

    var timer = document.getElementById("timer");
    var timerNum = null;
    var timerResetSec = 180;

    function timerStart() {
        clearInterval(timerNum);
        var count = timerResetSec;
        timer.innerHTML = count;
        timerNum = setInterval(function () {
            if (count > 1) {
                count = count - 1;
                timer.innerHTML = `${count}`;
            }
            else {
                clearInterval(timerNum);
                container.setAttribute("class", "playing timeout");
                timer.innerHTML = "OUT!";
                stopSound(10);
                stopSound(11);
                stopSound(12);
                stopSound(13);
            }
        }, 1000);
    }
    function timerStop() {
        clearInterval(timerNum);
    }




    // ******************************
    // 
    //      音樂撥放器
    //      - 
    //      - 
    //
    // ******************************



    var bufferBox = [];
    var audioUrlList = [
        // UI SFX 0-4
        "music/ui_01.mp3",
        "music/ui_02.mp3",
        "music/ui_04.wav",
        "music/default.aac",
        "music/default.aac",
        //Time SFX 5-10
        "music/default.aac",
        "music/default.aac",
        "music/default.aac",
        "music/default.aac",
        "music/default.aac",
        //bgm 10-13
        "music/bgm_BrandNewToy.mp3",
        "music/bgm_cut-to-the-chase.mp3",
        "music/bgm_greensleeves.mp3",
        "music/default.aac"
    ];

    // Fix up prefixing
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    var ctx = new AudioContext();

    function loadSound(num) {
        url = audioUrlList[num]
        var request = new XMLHttpRequest();
        request.open('GET', url, true);
        request.responseType = 'arraybuffer';

        // Decode asynchronously
        request.onload = function () {
            ctx.decodeAudioData(request.response, function (buffer) {
                bufferBox[num] = buffer;               // 將 buffer 倒入清單管理
            }, onError);
        }
        request.send();
    }



    // 將清單內的音樂載入Buffer
    for (let i = 0; i < audioUrlList.length; i++) {
        loadSound(i)
    }



    //創一個的音源 與連接節點倒終點

    var sourceBox = [];

    function playSound(num, loop = false) {
        buffer = bufferBox[num];
        var source = ctx.createBufferSource();         // creates a sound source
        sourceBox[num] = source                            // 將 Souece 倒入清單管理
        sourceBox[num].loop = loop;
        sourceBox[num].buffer = buffer;                    // tell the source which sound to play
        sourceBox[num].connect(ctx.destination);       // connect the source to the ctx's destination (the speakers)
        sourceBox[num].start(0);                           // play the source now

        
    }


    function stopSound(num) {
        try {
            sourceBox[num].disconnect(ctx.destination);
        }
        catch (e) {
            console.log("Source", num, "is not playing")
        }

    }

    // 長音源
    bgmSource01=document.getElementById("bgm01");
    bgm01Source = ctx.createMediaElementSource(bgmSource01);




    // 測試鍵盤快捷鍵
    window.addEventListener("keydown", torandomTest, false);
    function torandomTest(e) {
        var keyID = e.code;
        if (keyID === 'KeyQ') {
            
        };
        if (keyID === 'KeyW') {
            
        };
        if (keyID === 'KeyE') {
            
        };
        if (keyID === 'KeyR') {
           
        }
        if (keyID === 'KeyT') {
            
        }

    }







    // ******************************
    // 
    //      Main fuction
    //      - to_start()
    //      - to_home()
    //      - nextQ()
    //      -
    //      - toTimerResetSec(sec)      設定遊戲的秒數
    //      - setTime_btns()            設定秒數按鈕的執行動作
    //      - inputTimerResetSec(mode)  填入秒數按鈕的執行秒數
    //      -
    //      - setGameType()             遊戲模式設定
    //      - gameTypeChange()          切換遊戲模式
    //
    // ******************************

    var hotkeyBox = document.getElementById("hotkey")
    var container = document.getElementById("container")
    var answerCountbox = document.getElementById("answer_count")
    var body = document.querySelector("body")
    var time_btn = document.getElementsByClassName("time_btn")


    var answerCount = 0
    var gameType = 0


    // ******************************
    // 基本控制
    // ******************************

    function to_start() {
        container.setAttribute("class", "playing");
        hotkeyBox.innerHTML = "Press N + 1 , B + 0 , Press H to back Home";
        timerStart()
        QintoHTML()
        if (tagQList==1){
            playSound(11, true)
        }
        else if(tagQList==2){
            playSound(12, true)
        }
        else{
            playSound(10, true)
        }
        
    };
    function to_home() {
        container.setAttribute("class", "home");
        hotkeyBox.innerHTML = "Click Game Name to Start";
        timerStop()
        answerCount = 0                                     // 重設執行答對題目
        answerCountbox.innerHTML = answerCount;
        toTimerResetSec(timerResetSecList[TimerResetNum])   // 重設秒數
        Qlisting = Qlist                                    // 重設執行遊戲的問題集
        stopSound(10)
        stopSound(11)
        stopSound(12)
        stopSound(13)
    }

    function nextQ(score=1,music=1) {
        QintoHTML();
        answerCount=answerCount+score
        answerCountbox.innerHTML = answerCount;
        // 換題重設秒數，且減一秒 (給快問快答使用)
        if (gameType == 1) {
            timerStop()
            timerStart()
            if (timerResetSec > 5) {
                timerResetSec = timerResetSec - 1
            }
        }
        playSound(music)
    }




    // ******************************
    // 首頁時間按鈕功能
    // ******************************
    var timerResetSecList = []
    var TimerResetNum = 2

    // 設定遊戲的秒數
    function toTimerResetSec(sec) {
        if (sec == "none") {
            timerResetSec = 9999;
            timer.classList.add("hidden");
        }
        else {
            timerResetSec = sec;
            timer.classList.remove("hidden");
        }
    }

    // 設定秒數按鈕的執行動作
    function setTime_btns() {
        for (let i = 0; i < time_btn.length; i++) {
            time_btn[i].addEventListener('click', function () { toTimerResetSec(timerResetSecList[i]); time_btnActiver(i); TimerResetNum = i; }, false);
            time_btn[i].innerHTML = timerResetSecList[i];

        }
    }

    // 填入秒數按鈕的執行秒數    
    function inputTimerResetSec(mode) {
        if (mode == "mode_00") {
            timerResetSecList = ["none", 180, 150, 120, 60]
            setTime_btns()
        }
        else {
            timerResetSecList = ["none", 30, 20, 10, 5]
            setTime_btns()
        }
    }


    // ******************************
    // 遊戲模式
    // ******************************

    // 遊戲模式設定
    function setGameType() {
        if (gameType == 0) {
            game_name.innerHTML = "比手</br>畫腳"
            changeQList(Qlist_0_01)
            body.classList.remove("gametype_01")
            body.classList.add("gametype_00")
            inputTimerResetSec("mode_00")
        }
        else {
            game_name.innerHTML = "快問</br>快答"
            changeQList(Qlist_1_01)
            body.classList.remove("gametype_00")
            body.classList.add("gametype_01")
            inputTimerResetSec("mode_01")
        }
    }

    // 切換遊戲模式
    function gameTypeChange() {
        if (gameType == 0) {
            gameType = 1;
            setGameType()
            toTimerResetSec(timerResetSecList[TimerResetNum])
        }
        else {
            gameType = 0;
            setGameType()
            toTimerResetSec(timerResetSecList[TimerResetNum])
        }
    }



    // 錯誤提示
    function onError() {
        console.log("error")
    }


    // ******************************
    // 
    //      Load Page
    //
    // ******************************


    hotkeyBox.innerHTML = "Click Game Name to Start";
    answerCountbox.innerHTML = answerCount;
    inputTimerResetSec("mode_00")






    // ******************************
    // 
    //      控制器、快捷鍵
    //
    // ******************************


    // 按鈕 
    var home_btn = document.getElementById("home_btn")
    var screen_click = document.getElementById("screen_click")
    var game_name = document.getElementById("game_name")
    var swich_btn = document.getElementById("swich_btn")
    var Qlist_btn = document.getElementsByClassName("Qlist_btn")
    var next_btn = document.getElementsByClassName("next_btn")



    home_btn.addEventListener('click', to_home, false);
    game_name.addEventListener('click', to_start, false);
    swich_btn.addEventListener('click', gameTypeChange, false);
    next_btn[0].addEventListener('click', function(){nextQ(0,2)}, false);
    next_btn[1].addEventListener('click', function(){nextQ()}, false);
    // screen_click.addEventListener('click', function(){nextQ()}, false);



    // 選取時間按鈕狀態 
    function time_btnActiver(x) {
        for (let i = 0; i < 5; i++) {
            time_btn[i].classList.remove("active");          
        }
        time_btn[x].classList.add("active");
        playSound(0)
    }





    // 設定換題目組按鈕的執行動作
    var tagQList = 0
    function setQlist_btn() {
        for (let i = 0; i < Qlist_btn.length; i++) {
            Qlist_btn[i].addEventListener('click', function () {
                changeQList(Qlist_0s[i]);
                playSound(0)
                tagQList = i
            }, false);
        }
    }
    setQlist_btn()








    // 鍵盤快捷鍵
    window.addEventListener("keydown", torandom, false);
    function torandom(e) {
        var keyID = e.code;
        if (keyID === 'KeyN') {
            nextQ()
        };
        if (keyID === 'Space') {
            nextQ()
        };
        if (keyID === 'KeyB') {
            nextQ(0,3)
        };
        if (keyID === 'KeyH') {
            to_home()
        }
        if (keyID === 'KeyS') {
            to_start()
        }

    }



</script>

</html>
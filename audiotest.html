<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>audio</title>
</head>
<style>
    body {
        background-color: #222;
    }
</style>

<body>



</body>

<script>


    // ******************************
    // 
    //      音樂撥放器
    //      - 
    //      - 
    //
    // ******************************



    // Fix up prefixing
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    var ctx = new AudioContext();


    // console.log(this.ADSR.attack)




    var hz={
            C : 261.63,
            Cs: 277.18,
            D : 293.66,
            Ds: 311.13,
            E : 329.63,
            F : 349.23,
            Fs: 369.99,
            G : 392.00,
            A : 440.00,
            As: 466.16,
            B : 493.88,
            C5 :1046.5,
            C5s:1108.7,
            D5 :1174.7,
            D5s:1244.5,
            E5 :1318.5,
            F5 :1396.9,
            F5s:1568.0,
            G5 :1661.2,
            A5 :1760.0,
            A5s:1864.7,
            B5 :1975.5
        }





    var osc = function(){
          // Create 
        
        
        // this.gainCode.gain.value = 0 // 音量

        this.ADSR={
            attack : 0.01,
            delay : 0.3,
            sustain : 0.5,
            release : 0.1
        }

 

        this.compressor = ctx.createDynamicsCompressor();
        this.compressor.threshold.setValueAtTime(-50, ctx.currentTime);
        this.compressor.knee.setValueAtTime(40, ctx.currentTime);
        this.compressor.ratio.setValueAtTime(12, ctx.currentTime);
        this.compressor.attack.setValueAtTime(0, ctx.currentTime);
        this.compressor.release.setValueAtTime(0.25, ctx.currentTime);


        this.compressor.connect(ctx.destination);       
        console.log("create")
        this.ADSR={
            attack : 0.01,
            delay : 0.3,
            sustain : 0.5,
            release : 1
        }


        this.play = function (frequency) {
            console.log(frequency)
            let pressTime = 1;

            this.gainCode = ctx.createGain()
            this.oscSource = ctx.createOscillator()
            this.oscSource.type = 'sine' // 正弦波
            this.oscSource.frequency.value = frequency// A4 頻率
            this.oscSource.detune.value = 0 // 解諧
        

            this.gainCode02 = ctx.createGain()
            this.gainCode02.gain.value = 0.1

            this.lowPassCode = ctx.createBiquadFilter();
            this.lowPassCode.type = 'lowpass';
            this.lowPassCode.frequency.value = 1000;


            this.oscSource02 = ctx.createOscillator()
            this.oscSource02.type = 'sawtooth' // 正弦波
            this.oscSource02.frequency.value = frequency// A4 頻率
            this.oscSource02.detune.value = 0 // 解諧
            


            //Attack
            this.gainCode.gain.value = 0
            this.gainCode.gain.linearRampToValueAtTime(1, ctx.currentTime + this.ADSR.attack);
            
            //Decay

            this.gainCode.gain.linearRampToValueAtTime(this.ADSR.sustain, ctx.currentTime + this.ADSR.attack + this.ADSR.delay);

            //Release

            this.gainCode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + this.ADSR.release);

            
            this.oscSource02.connect(this.lowPassCode).connect(this.gainCode02).connect(this.gainCode)
            this.oscSource.connect(this.gainCode).connect(this.compressor)

            this.oscSource.start(ctx.currentTime)
            this.oscSource.stop(ctx.currentTime+pressTime+this.ADSR.release)
            this.oscSource02.start(ctx.currentTime)
            this.oscSource02.stop(ctx.currentTime+pressTime+this.ADSR.release)
        }
    }


    var os = new osc()



    // 測試鍵盤快捷鍵
    window.addEventListener("keydown", torandomTest, false);
    function torandomTest(e) {
        var keyID = e.code;
        if (keyID === 'KeyQ') {
            os.play(hz.C)
        };
        if (keyID === 'KeyW') {
            os.play(hz.D) 
        };
        if (keyID === 'KeyE') {
            os.play(329.63)
        };
        if (keyID === 'KeyR') {
            os.play(349.23)
        }
        if (keyID === 'KeyT') {
            os.play(392.00)
        }
        if (keyID === 'KeyY') {
            os.play(440)
        }
        if (keyID === 'KeyU') {
            os.play(493.88)
        }
        if (keyID === 'KeyI') {
            os.play(523.25)
        }
        if (keyID === 'KeyO') {
            os.play(587.33)
        }
        if (keyID === 'KeyP') {
            os.play(659.26)
        }
    }





    // Audio Effect 短音效

    // var bufferBox = [];
    // var audioUrlList = [
    //     "music/ui_01.mp3",
    //     "music/ui_02.mp3",
    //     "music/ui_04.wav",
    //     "music/out_logos---classic.aac",
    //     "music/x_laughing.mp3",
    //     "music/out_BoardGamesDominoTilesFalling.aac"
    // ];

    // function loadSound(num) {
    //     url = audioUrlList[num]
    //     var request = new XMLHttpRequest();
    //     request.open('GET', url, true);
    //     request.responseType = 'arraybuffer';

    //     // Decode asynchronously
    //     request.onload = function () {
    //         ctx.decodeAudioData(request.response, function (buffer) {
    //             bufferBox[num] = buffer;               // 將 buffer 倒入清單管理
    //         }, onError);
    //     }
    //     request.send();
    // }

    // // 將清單內的音樂載入Buffer
    // for (let i = 0; i < audioUrlList.length; i++) {
    //     loadSound(i)
    // }

    // //創一個的音源 與連接節點倒終點

    // function playSound(num,gain=1) {
    //     buffer = bufferBox[num];
    //     var source = ctx.createBufferSource();                      // creates a sound source
    //     var gainCode = ctx.createGain();
    //     gainCode.gain.value =gain
    //     source.buffer = buffer;                                   // tell the source which sound to play
    //     source.connect(gainCode).connect(ctx.destination);        // connect the source to the ctx's destination (the speakers)
    //     source.start(0);                                          // play the source now
    // }












    // // BGM 長音樂
    
    // var music = function(num){
    //     this.source = ctx.createMediaElementSource(bgmSource[num]);
    //     this.gainCode = ctx.createGain();
    //     this.lowPassCode = ctx.createBiquadFilter();
    //     this.source.connect(this.gainCode).connect(this.lowPassCode).connect(ctx.destination);

    //     // option
    //     this.playingTag = 0   
    //     this.lowPassCode.type = 'lowpass'; 
    //     this.lowPassCode.frequency.value = 22050;

    //     // function
    //     this.play = function(){
    //         this.playingTag = 1
    //         bgmSource[num].play() 
    //     }
    //     this.fadePlay = function(gain=1,fadeTime=1,startGain=0){
    //         this.play();
    //         this.gainCode.gain.value = startGain
    //         this.gainCode.gain.linearRampToValueAtTime(gain, ctx.currentTime+10);
    //     }
    //     this.stop = function(){
    //         this.playingTag = 0
    //         bgmSource[num].pause()
    //         bgmSource[num].currentTime = 0;
    //     }
    //     this.fadeStop = function(fadeTime=1){          
    //         if(this.playingTag == 1){
    //             this.playingTag = 0               
    //             let tempGain = this.gainCode.gain.value
    //             this.gainCode.gain.linearRampToValueAtTime(0, ctx.currentTime+fadeTime);
    //             setTimeout(() => {               
    //                 if(this.playingTag == 1){
    //                     this.gainCode.gain.linearRampToValueAtTime(tempGain, ctx.currentTime+0.5);
    //                     console.log("replay")
    //                 }
    //                 else {
    //                     this.stop()
    //                     this.gainCode.gain.value = tempGain
    //                 }                   
    //             }, fadeTime*1000+100); 
    //         }
    //     }
    //     this.fadeLowPass=function(frequency=22050,gain=-40,fadeTime=1){
    //         this.lowPassCode.frequency.linearRampToValueAtTime(frequency,ctx.currentTime+fadeTime);
    //     }
    // }





</script>
</html>
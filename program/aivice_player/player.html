<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="#">
    <title>Player</title>
</head>
<style>
    * {
        position: relative;
        box-sizing: border-box;
    }

    body,
    html {
        font-family: "Noto sans TC", "Noto sans", "Microsoft JhengHei", "微軟正黑體", sans-serif;
        font-weight: 300;
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        background-color: #262628;
        color: #fff;
    }

    .container {
        max-width: 1440px;
        width: 100%;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .row {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        margin: 0 20px;
    }

    .col-1-1 {
        width: 100%;
    }

    .col-1-4 {
        width: 25%;
    }

    #entermask {
        width: 100%;
        height: 100%;
        background-color: #a5a5a5;
        display: none;
    }

    #fullScreenBtn {
        background-color: #545454;
        width: 40px;
        height: 40px;
        position: fixed;
        right: 12px;
        bottom: 12px;
        border-radius: 50% 50% 0 50%;
    }
</style>



<body>
    <div class="container">
        <canvas id="canvas"></canvas>
        New
    </div>
    <div id="entermask"></div>
    <div id="fullScreenBtn"></div>
    <audio class="bgm" src="stay-humble.wav"></audio>
    <audio class="bgm" src="bgm_logos-1.mp3"></audio>
    <audio class="bgm" src="bgm_BrandNewToy.mp3"></audio>
    <audio class="bgm" src="bgm_cut-to-the-chase.mp3"></audio>
    <audio class="bgm" src="ch_good.mp3"></audio>
    <audio class="bgm" src="bgm_logos-2.wav"></audio>
    <audio class="bgm" src="bgm_NewCity.mp3"></audio>
    <audio class="bgm" src="ui_03.mp3"></audio>

</body>
<script>

    // Function
    var $id = function (name) {
        return document.getElementById(name)
    }
    var $css = function (name) {
        return document.getElementsByClassName(name)
    }
    var $tag = function (name) {
        return document.getElementsByTagName(name)
    }








    // ******************************
    // 
    //      音樂撥放器
    //      - 
    //      - 
    //
    // ******************************



    // Fix up prefixing
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    var ctx = new AudioContext();

    const canvas = document.getElementById('canvas');
    const ctxx = canvas.getContext('2d');
    canvas.height = 800
    canvas.width = 1200
    // BGM 長音樂

    var music = function (num) {
        this.source = ctx.createMediaElementSource(bgmSource[num]);
        this.gainCode = ctx.createGain();
        this.lowPassCode = ctx.createBiquadFilter();
        this.analyser = ctx.createAnalyser();
        this.source.connect(this.gainCode).connect(this.lowPassCode).connect(this.analyser).connect(ctx.destination);







        // Uint8Array to receive frequency data
        this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);


        this.draw = function () {
            this.drawing = requestAnimationFrame(this.draw.bind(this));
            this.analyser.getByteFrequencyData(this.dataArray);
            // console.log(this.dataArray)
            // 使用dataArray来更新你的视觉元素，比如文字的大小、颜色等


            ctxx.clearRect(0, 0, canvas.width, canvas.height); // clear the canvas
            // draw each item in dataArray as a bar on the canvas
            for (let i = 0; i < this.dataArray.length; i++) {
                ctxx.fillRect(i * 1, canvas.height, 1, -this.dataArray[i]);
            }
        }

        this.stopDraw = function () {
            cancelAnimationFrame(this.drawing);
        }











        // option
        this.playingTag = 0
        this.lowPassCode.type = 'lowpass';
        this.lowPassCode.frequency.value = 22050;

        // function
        this.play = function () {
            if (this.playingTag === 0) { // 如果尚未在播放
                this.playingTag = 1
                bgmSource[num].play()
                bgmSource[num].addEventListener('ended', function () {
                    console.log("do something")
                    this.stop();
                }.bind(this));
            }
        }
        this.fadePlay = function (gain = 1, fadeTime = 1, startGain = 0) {
            this.play();
            this.gainCode.gain.value = startGain
            this.gainCode.gain.linearRampToValueAtTime(gain, ctx.currentTime + fadeTime);
        }
        this.stop = function () {
            this.playingTag = 0
            bgmSource[num].pause()
            bgmSource[num].currentTime = 0;
        }
        this.fadeStop = function (fadeTime = 1) {
            if (this.playingTag == 1) {
                this.playingTag = 0
                let tempGain = this.gainCode.gain.value
                this.gainCode.gain.linearRampToValueAtTime(0, ctx.currentTime + fadeTime);
                //如果在漸弱中再次 Play > 等漸弱後判斷是否 play 有則在0.5秒後回復音量
                setTimeout(() => {
                    if (this.playingTag == 1) {
                        this.gainCode.gain.linearRampToValueAtTime(tempGain, ctx.currentTime + 0.5);
                        console.log("replay")
                    }
                    else {
                        this.stop()
                        this.gainCode.gain.value = tempGain
                    }
                }, fadeTime * 1000 + 100);
            }
        }
        this.fadeLowPass = function (frequency = 22050, gain = -40, fadeTime = 1) {
            this.lowPassCode.frequency.linearRampToValueAtTime(frequency, ctx.currentTime + fadeTime);
        }
    }






    // 帶入聲音
    bgmSource = document.getElementsByClassName("bgm");
    var bgm = []
    for (let i = 0; i < bgmSource.length; i++) {
        bgm[i] = new music(i)
    }


    // 全部停止
    function musicAllStop(fadeTime = 1) {
        for (let i = 0; i < bgmSource.length; i++) {
            bgm[i].fadeStop(fadeTime)
        }
    }



    // 鍵盤快捷鍵
    window.addEventListener("keydown", torandomTest, false);
    function torandomTest(e) {
        var keyID = e.code;
        if (keyID === 'Numpad7') {
            musicAllStop(1)
            bgm[2].play()
        }
        if (keyID === 'Numpad4') {
            musicAllStop(1)
            bgm[1].play()
        }
        if (keyID === 'Numpad1') {
            musicAllStop(1)
            bgm[0].play()
        }
        if (keyID === 'KeyQ') {
            musicAllStop(1)
        }
        if (keyID === 'KeyA') {
            bgm[0].draw()

        }
        if (keyID === 'KeyF') {
            bgm[0].stopDraw()
        }

    }





    // ******************************
    // 其他功能
    // ******************************


    $id("fullScreenBtn").addEventListener("click", function () {
        if (!document.fullscreenElement) {
            $tag("body")[0].requestFullscreen()
        }
        else {
            document.exitFullscreen()
        }
    })


    // 錯誤提示
    function onError() {
        console.log("error")
    }

    // var myInterval = setInterval(function () {
    //     console.log(bgm[0].gainCode.gain.value);
    // }, 200);



    // chrome.runtime.onMessage.addListener(async (request, sender, sendResponse) => {
    //     try {
    //         const result = await asyncFunction(request);
    //         sendResponse(result);
    //     } catch (error) {
    //         // handle the error
    //         console.error(error);
    //     }
    //     return true;  // Will respond asynchronously.
    // });


</script>

</html>
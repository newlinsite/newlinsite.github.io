<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="kvmgame.css">
</head>

<body>
    <div class="container"></div>
</body>
<script src="../library/voiceControl.js"></script>
<script>
    var $id = function (name) {
        return document.getElementById(name)
    }
    var $css = function (name) {
        return document.getElementsByClassName(name)
    }
    var $tag = function (name) {
        return document.getElementsByTagName(name)
    }
    var test = function (print = "test") {
        console.log(print)
    }
    function nothing() {
        console.log("nothing")
    }



    var audioList = [
        "../aten/MRS/music/001.aac",
        "../aten/MRS/music/003.aac",
        "../aten/MRS/music/002.aac",
        "../aten/MRS/music/004.aac",
        "../aten/MRS/music/ui_01.mp3",
        "../aten/MRS/music/ui_02.mp3",
        "../aten/MRS/music/ui_04.wav",
        "../aten/MRS/music/out_logos---classic.aac"
    ];
    var sound = new Sound(audioList)


    // ------------------------
    // toggle
    // ------------------------

    toggle = (tagObj, do1, do0, autoSwitchTag = true) => {
        if (tagObj.tag === 0) {
            do1()
            if (autoSwitchTag) {
                tagObj.tag = 1
            }
        } else {
            do0()
            if (autoSwitchTag) {
                tagObj.tag = 0
            }
        }
    }



    class Item {
        constructor(attr, style) {
            this.type = attr.type
            this.state = 0
            this.object = document.createElement("div")
            this.object.classList = style
            // this.object.style.backgroundImage = "url(" + attr.item[i].background + ")"
            this.object.style.backgroundColor = "#333"
            this.object.style.width = attr.size[0] + "%"
            this.object.style.paddingTop = attr.size[1] + "%"
            this.object.style.left = attr.xyr[0] + "%"
            this.object.style.top = attr.xyr[1] + "%"
            this.object.style.transform = "translate(-50%, -50%) rotate(" + attr.xyr[2] + "deg)"
        }
        on(url, color = "#555") {
            this.state = 1
            this.object.style.backgroundColor = "#555"
            // this.object.style.backgroundImage = "url(" + url + ")"
        }
        off() {
            this.state = 0
            this.object.style.backgroundColor = "#333"
            // this.object.style.backgroundImage = "url(" + attr.item[i].background + ")"
        }
    }
    class Saying { }

    class Dialog {
        constructor(text, buttonText = "Skip", duration = 3000, isAvatar = true) {
            this.isAvatar = isAvatar
            this.container = document.createElement("div");
            //判斷 對話框 or 小K
            if (isAvatar) {
                this.container.classList.add("character-dialog");
                this.avatar = document.createElement("div");
                this.avatar.classList.add("avatar");
                this.container.appendChild(this.avatar);
            } else {
                this.container.classList.add("dialog");
            }

            this.dialog = document.createElement("div");
            this.dialog.classList.add("dialog");
            this.container.appendChild(this.dialog);

            this.text = text;
            this.buttonText = buttonText;
            this.duration = duration;
            this.timer = null;

            this.dialogText = "";
            this.currentIndex = 0;

            this.dialog.appendChild(document.createElement("span"));

            this.addButton();
            container.appendChild(this.container);
        }

        addButton() {
            const button = document.createElement("button");
            button.textContent = this.buttonText;
            button.addEventListener("click", () => this.skip());
            this.container.appendChild(button);
        }

        skip() {
            this.dialogText = this.text;
            this.dialog.firstChild.textContent = this.dialogText;
            clearInterval(this.timer);
            this.remove();
        }

        typeText() {
            this.dialogText += this.text.charAt(this.currentIndex);
            this.dialog.firstChild.textContent = this.dialogText;
            this.currentIndex++;
            if (this.currentIndex === this.text.length) {
                clearInterval(this.timer);
                setTimeout(() => this.remove(), this.duration);
            }
        }

        show() {
            this.timer = setInterval(() => this.typeText(), 100);
            this.container.classList.add("fadeInLeft")
            if (this.isAvatar) {
                this.avatar.classList.add("fadeInLeft")
            }

        }

        remove() {
            clearInterval(this.timer);
            this.container.classList.add("fadeOut")
            setInterval(() => this.container.remove(), 500);

        }
    }


    class GameScene {
        constructor(
            attr
        ) {
            this.object = document.createElement("div")
            this.object.classList = "gameScene"
            this.state = 0
            this.level = attr.level

            // Button Item 
            this.btn = []
            for (let i = 0; i < attr.btn.length; i++) {
                this.btn[i] = new Item(attr.btn[i], "btn")
                this.btn[i].object.addEventListener("click", () => {
                    attr.btn[i].act()
                })
                this.object.appendChild(this.btn[i].object)
            }
            container.appendChild(this.object)


            // gameItem 
            this.item = []
            this.selectedItem = "" //儲存用
            for (let i = 0; i < attr.item.length; i++) {
                this.item[i] = new Item(attr.item[i], "gameItem")
                this.item[i].object.addEventListener("click", () => {
                    if (this.item[i].state == 0) {
                        sound.play(4)
                        this.item[i].on()
                        if (this.level / 100 < 2) {
                            this.ruleCheckMatch(i)
                        } else {
                            this.ruleFind(i, "K")
                        }
                    }
                })
                this.object.appendChild(this.item[i].object)
            }
            container.appendChild(this.object)

            // Mask
            this.mask = document.createElement("div")
            this.mask.classList = "mask"
            this.object.appendChild(this.mask)

            // Score Note
            this.scoreNote = document.createElement("div")
            this.scoreNote.classList = "scoreNote"
            this.object.appendChild(this.scoreNote)
            this.scoreNoteNumber = document.createElement("div")
            this.scoreNoteNumber.classList = "scoreNoteNumber"
            this.scoreNote.appendChild(this.scoreNoteNumber)

            //其他參數
            this.tag = [{ tag: 0 }, { tag: 0 }, { tag: 0 }]
            this.openTag = { tag: 0 }
        }

        ruleCheckMatch(num) {
            if (this.selectedItem != "") {
                if (this.selectedItem.type === this.item[num].type) {
                    this.addScore(1)
                } else {
                    this.addScore(-1)
                }
                setTimeout(() => {
                    this.selectedItem.off()
                    this.item[num].off()
                    this.selectedItem = ""
                }, 500)
            } else {
                this.selectedItem = this.item[num]
            }
        }
        ruleFind(num, type) {
            if (this.item[num].type === type) {
                this.addScore(1)
            } else {
                this.addScore(-1)
            }
            this.item[num].off()
        }

        addScore(score) {
            game.score = game.score + score
            test("" + score + ", Score : " + game.score)
            this.onMask()
            this.onScoreNote(score)
        }
        open() {
            this.object.style.height = 100 + "%"
            this.object.style.width = 100 + "%"
            this.object.style.opacity = 1
            this.openTag = { tag: 1 }
        }
        close() {
            this.object.style.height = 0 + "%"
            this.object.style.width = 0 + "%"
            this.object.style.opacity = 0
            this.openTag = { tag: 0 }
        }
        opentaggle() {
            toggle(this.openTag,
                () => this.open(),
                () => this.close()
            )
        }
        onMask(fideOutTime = 200, offTime = 500) {
            this.mask.style.display = "inline-block"
            this.mask.style.opacity = 0.2
            setTimeout(() => {
                this.mask.style.opacity = 0
            }, fideOutTime)
            setTimeout(() => {
                this.mask.style.display = "none"
            }, offTime)
        }

        onScoreNote(score, fideOutTime = 300, offTime = 600) {
            this.scoreNote.style.display = "inline-block"
            this.scoreNote.style.opacity = 1
            this.scoreNoteNumber.textContent = score
            setTimeout(() => {
                this.scoreNote.style.opacity = 0
            }, fideOutTime)
            setTimeout(() => {
                this.scoreNote.style.display = "none"
            }, offTime)
        }

    }


    class Game {
        constructor() {
            this.nowLevel = [0, 0]
            this.score = 0
            this.time = 0
        }


        start() {
            scene[0].close()
        }

        goHome() {
            scene[0].open()
        }

        goToScorePage() { }


        goToLevel(num) {
            const randomIndex = Math.floor(Math.random() * gameLevel[num].length);
            if (this.nowLevel[0] != num) {
                gameLevel[num][randomIndex].open()
                gameLevel[this.nowLevel[0]][this.nowLevel[1]].close()

                this.nowLevel = [num, randomIndex]

                test("level now is " + this.nowLevel)
            }
        }

        startTimer(aTime = 1000, act = () => console.log(this.time)) {
            this.timer = setInterval(() => {
                this.time = this.time + 1
                act()
            }, aTime);
        }
        stopTimer() {
            clearInterval(this.timer)
            this.time = 0
        }
    }



    ///---------------------------------
    //
    //
    //      入場
    //
    //
    ///---------------------------------


    gameLevelAttr = [
        [{
            level: 101, background: "",
            item: [
                { type: "A", size: [10, 10], xyr: [50, 30, 45], background: "" },
                { type: "A", size: [10, 10], xyr: [50, 50, 45], background: "" },
                { type: "B", size: [10, 10], xyr: [50, 70, 0], background: "" },
                { type: "B", size: [10, 10], xyr: [50, 90, 0], background: "" },
            ], btn: []
        }, {
            level: 102, background: "",
            item: [
                { type: "A", size: [10, 10], xyr: [50, 30, 0], background: "" },
                { type: "A", size: [10, 10], xyr: [50, 50, 0], background: "" },
                { type: "B", size: [10, 10], xyr: [0, 70, 45], background: "" },
                { type: "B", size: [10, 10], xyr: [50, 90, 45], background: "" },
            ], btn: []
        }, {
            level: 103, background: "",
            item: [
                { type: "A", size: [10, 10], xyr: [10, 30, 0], background: "" },
                { type: "A", size: [10, 10], xyr: [50, 50, 0], background: "" },
                { type: "B", size: [10, 10], xyr: [10, 50, 45], background: "" },
                { type: "B", size: [10, 10], xyr: [50, 90, 45], background: "" },
            ], btn: []
        }], [{
            level: 201, background: "",
            item: [
                { type: "A", size: [20, 10], xyr: [40, 50, 25], background: "" },
                { type: "A", size: [10, 20], xyr: [50, 20, 15], background: "" }
            ], btn: []
        }], [{
            level: 301, background: "",
            item: [
                { type: "A", size: [20, 10], xyr: [40, 50, 25], background: "" },
                { type: "A", size: [10, 20], xyr: [50, 20, 15], background: "" },
                { type: "K", size: [10, 20], xyr: [30, 30, 0], background: "" }
            ], btn: []
        }]
    ]

    sceneAttr = [
        {
            level: "home", background: "", item: [],
            btn: [
                { name: "start", size: [30, 15], xyr: [50, 50, 0], background: "", act: () => game.startGame() },
                { name: "kCyan", size: [30, 30], xyr: [80, 90, 0], background: "", act: nothing },
                { name: "mute", size: [10, 10], xyr: [10, 5, 0], background: "", act: nothing }
            ]
        }, {
            level: "levelPage",
            background: "", item: [],
            btn: [
                { name: "start", size: [30, 15], xyr: [50, 50, 0], background: "", act: nothing },
            ]
        }, {
            level: "scorePage",
            background: "", item: [],
            btn: [

            ]
        }
    ]


    container = $css("container")[0]
    game = new Game()

    gameLevel = []
    for (let i = 0; i < gameLevelAttr.length; i++) {
        gameLevel[i] = Array.from({ length: gameLevelAttr[i].length }, (_, j) => new GameScene(gameLevelAttr[i][j]))
    }




    var scene = Array.from({ length: sceneAttr.length }, (_, i) => new GameScene(sceneAttr[i]))


    gameLevel[0][0].open()
    game.goHome()

    test(gameLevel)
    test(scene)
    test(gameLevelAttr.length)

    ///---------------------------------
    //
    //
    //      互動
    //
    //
    ///---------------------------------

    window.addEventListener("keydown", keyboardListener, false);

    function keyboardListener(e) {
        var keyID = e.code;
        if (keyID === 'KeyQ') {
            // gameLevel[0].opentaggle()
            game.start()
        }

        if (keyID === 'KeyW') {
            game.goHome()
        }
        if (keyID === 'KeyA') {
            game.stopTimer()
        }
        if (keyID === 'KeyQ') {
            game.goToLevel(0)
        }
        if (keyID === 'KeyA') {
            game.goToLevel(1)
        }
        if (keyID === 'KeyZ') {
            game.goToLevel(2)
        }
        if (keyID === 'KeyD') {
            const characterDialog = new Dialog("Hello, how are you?", "Continue", 100000);
            characterDialog.show();
        }

    }


</script>

</html>
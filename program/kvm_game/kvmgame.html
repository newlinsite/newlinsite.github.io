<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="kvmgame.css">
</head>

<body>
    <div class="gameOutContainer">
        <div class="gameContainer"></div>
        <div class="openMask">
            <div class="balls">
                <div></div>
                <div></div>
                <div></div>
            </div>
            <div class="startBtn">
                <p>GO!</p>
            </div>
        </div>

    </div>
</body>
<script src="../library/voiceControl.js"></script>
<script>
    var $id = function (name) {
        return document.getElementById(name)
    }
    var $css = function (name) {
        return document.getElementsByClassName(name)
    }
    var $tag = function (name) {
        return document.getElementsByTagName(name)
    }
    var test = function (print = "test") {
        console.log(print)
    }
    function nothing() {
        // console.log("nothing")
    }



    var imageUrlPrefix = "//assets.aten.com/webpage/shared/campaign/global/kvmEveday/"
    var imageUrlPrefix = "image/"


    // ------------------------
    // toggle
    // ------------------------

    toggle = (tagObj, do1, do0, autoSwitchTag = true) => {
        if (tagObj.tag === 0) {
            do1()
            if (autoSwitchTag) {
                tagObj.tag = 1
            }
        } else {
            do0()
            if (autoSwitchTag) {
                tagObj.tag = 0
            }
        }
    }

    // ------------------------
    // Copy
    // ------------------------

    var copy = (copyText = "copy") => {
        const textarea = document.createElement('textarea');
        textarea.value = copyText;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
    }



    ///---------------------------------
    //
    //
    //      Class
    //
    //
    ///---------------------------------

    class Toast {
        constructor(text = "toast", duration = 1500, fadeTime = 1500, style = false, fadeStyle = "", where = container) {
            this.container = document.createElement("div");
            this.container.textContent = text
            where.appendChild(this.container)
            //如果沒有自設 style 套用預設
            if (style) {
                this.container.classList.add(style);
                setTimeout(() => {
                    this.container.classList.add(fadeStyle);
                }, duration)
            } else {
                this.container.style.color = "#333"
                this.container.style.position = "absolute"
                this.container.style.top = "90%"
                this.container.style.left = "50%"
                this.container.style.padding = "8px 16px"
                this.container.style.borderRadius = "8px"
                this.container.style.backgroundColor = "#eee"
                this.container.style.boxShadow = "0 2px 4px #000000ee"
                this.container.style.transition = fadeTime + "ms"
                this.container.style.transform = "translate(-50%, -50%)"
                setTimeout(() => {
                    this.container.style.opacity = "0"
                    this.container.style.transform = "translate(-50%, 0)"
                }, duration)
            }
            setTimeout(() => {
                this.container.remove()
            }, duration + fadeTime)

        }
    }
    class ImgToast {
        constructor(bg = "", duration = 1500, fadeTime = 1500, style = false, fadeStyle = "", fadeIn = false,
            xy = false, where = container, interImg = false) {

            this.container = document.createElement("div");
            this.container.style.backgroundImage = "url(" + imageUrlPrefix + bg + ")"
            where.appendChild(this.container)

            //設定位置
            if (xy) {
                this.container.style.left = xy[0]
                this.container.style.top = xy[1]
            }

            //插入圖
            if (interImg) {
                this.interImg = document.createElement("div");
                this.interImg.style.backgroundImage = "url(" + imageUrlPrefix + interImg[0] + ")"
                this.interImg.classList.add(interImg[1]);
                this.container.appendChild(this.interImg)
            }

            //如果沒有自設 style 套用預設
            if (style) {
                this.container.classList.add(style);
                if (fadeIn) {
                    //進場fade
                    this.container.classList.add(fadeStyle);
                    setTimeout(() => this.container.classList.remove(fadeStyle), 1)
                }
                //退場fade
                setTimeout(() => {
                    this.container.classList.add(fadeStyle);
                }, duration)
            } else {
                this.container.style.position = "absolute"
                this.container.style.top = "50%"
                this.container.style.left = "50%"
                this.container.style.width = "50%"
                this.container.style.paddingTop = "50%"
                this.container.style.backgroundPosition = "center"
                this.container.style.backgroundSize = "contain"
                this.container.style.backgroundRepeat = "no-repeat"
                this.container.style.transition = fadeTime + "ms"
                this.container.style.transform = "translate(-50%, -50%)"
                setTimeout(() => {
                    this.container.style.opacity = "0"
                }, duration)
            }
            setTimeout(() => {
                this.container.remove()
            }, duration + fadeTime)
        }
    }




    class Item {
        constructor(attr, style, simplyP = false, a = false) {
            this.type = attr.type
            this.state = 0
            this.color = attr.color

            if (a) {
                this.object = document.createElement("a")

            } else {
                this.object = document.createElement("div")
            }
            this.object.classList = style
            this.object.style.backgroundImage = "url(" + imageUrlPrefix + attr.background + ")"
            this.object.style.backgroundColor = attr.color
            this.object.style.width = attr.size[0] + "%"
            this.object.style.paddingTop = attr.size[1] + "%"
            this.object.style.left = attr.xyr[0] + "%"
            this.object.style.top = attr.xyr[1] + "%"
            this.object.style.transform = "translate(-50%, -50%) rotate(" + attr.xyr[2] + "deg)"
            if (simplyP) { // simplyP 輸入 1080 * 1920 絕對位置，用於直接輸入設計稿上的數字
                this.object.style.paddingTop = 0
                this.object.style.width = attr.size[0] / 10.80 + "%"
                this.object.style.height = attr.size[1] / 19.20 + "%"
                this.object.style.left = attr.xyr[0] / 10.80 + "%"
                this.object.style.top = attr.xyr[1] / 19.20 + "%"
                this.object.style.transform = "rotate(" + attr.xyr[2] + "deg)"
            }
        }
        on(url, style = "on") {
            this.state = 1
            this.object.classList.add(style)
            if (typeof url !== 'undefined') {
                this.object.style.backgroundImage = "url(" + url + ")"
            }
        }
        off(style = "on") {
            this.state = 0
            this.object.classList.remove(style)
            if (typeof url !== 'undefined') {
                this.object.style.backgroundImage = "url(" + attr.item[i].background + ")"
            }
        }
    }

    class Dialog {
        constructor(title, content, buttons = [{ t: "text", a: nothing }], timeOutT = "timeOutText", where = container) {
            this.where = where

            this.dialog = document.createElement("div");
            this.dialog.classList.add("dialog");

            this.titleText = title
            this.title = document.createElement("h5");
            this.title.innerHTML = this.titleText;
            this.dialog.appendChild(this.title);

            this.contentText = content
            this.content = document.createElement("p");
            this.content.textContent = this.contentText;
            this.dialog.appendChild(this.content);
            this.timeOutText = timeOutT

            this.btnBox = document.createElement("div");
            this.btnBox.classList.add("gameBtnBox");
            this.dialog.appendChild(this.btnBox);

            buttons.forEach((bb) => {
                const btn = document.createElement("button");
                btn.textContent = bb.t;
                btn.addEventListener("click", bb.a);
                this.btnBox.appendChild(btn);
            });
        }
        show(isTimeOut = false) {
            if (isTimeOut) {
                this.title.innerHTML = this.timeOutText;
            }
            this.content.textContent = this.contentText + game.score;
            this.where.appendChild(this.dialog);
            setTimeout(() => this.dialog.classList.add("fade"), 0);
            game.onMaskOn()
        }
        remove() {
            this.dialog.classList.remove("fade")
            setTimeout(() => { this.dialog.remove() }, 300);
            game.onMaskOff()
        }
    }

    class Say {
        constructor(text, avatarBg, buttonText = "Skip", duration = 3000, voice = false, act = nothing) {
            this.container = document.createElement("div");
            this.container.classList.add("say");
            this.duration = duration;
            this.timer = null;
            this.fadeTimer = null;


            this.text = text;
            this.nowText = "";
            this.nowTextIndex = 0;
            this.textBox = document.createElement("div");
            this.textBox.classList.add("textBox");
            this.textBox.appendChild(document.createElement("span"));
            this.container.appendChild(this.textBox);

            this.avatar = document.createElement("div");
            this.avatar.classList.add("avatar");
            this.avatar.style.backgroundImage = "url(" + imageUrlPrefix + avatarBg + ")";
            this.container.appendChild(this.avatar);

            this.button = document.createElement("button");
            this.button.textContent = buttonText;
            this.button.addEventListener("click", () => this.remove());
            this.container.appendChild(this.button);

            this.voice = voice
            this.act = () => act()
        }

        typeText() {
            this.nowText += this.text.charAt(this.nowTextIndex);
            this.textBox.firstChild.textContent = this.nowText;
            this.nowTextIndex++;
            if (this.nowTextIndex === this.text.length) {
                clearInterval(this.timer);
                setTimeout(() => this.remove(), this.duration);
            }
        }

        show(where = container, voice) {
            clearTimeout(this.fadeTimer)
            where.appendChild(this.container);
            this.timer = setInterval(() => this.typeText(), 110);
            setTimeout(() => this.container.classList.add("fadeIn"), 0)
            if (this.voice) {
                bgm[this.voice].play()
            }

        }

        remove(where = container) {
            clearInterval(this.timer);
            this.container.classList.remove("fadeIn")
            this.nowText = "";
            this.nowTextIndex = 0;
            this.fadeTimer = setTimeout(() => this.container.remove(), 500);
            bgm[this.voice].fadeStop()
            this.act()

        }
    }

    class GameScene {
        constructor(
            attr,
            simplyP = false
        ) {
            this.object = document.createElement("div")
            this.object.classList = "gameScene"
            this.object.style.backgroundImage = "url(" + imageUrlPrefix + attr.background + ")"
            this.state = 0
            this.level = attr.level
            this.gameFullTime = attr.gameTime
            this.gameKachiNum = attr.gameKachiNum
            this.gameNowNum = 0
            container.appendChild(this.object)

            this.playingTag = false

            // 創建 Button Item 
            if (attr.btn) {
                this.btn = []
                for (let i = 0; i < attr.btn.length; i++) {
                    this.btn[i] = new Item(attr.btn[i], "gameBtn")
                    this.btn[i].object.addEventListener("click", () => {
                        attr.btn[i].act()
                    })
                    this.object.appendChild(this.btn[i].object)
                }
            }
            // 創建連結
            if (attr.a) {
                this.a = []
                for (let i = 0; i < attr.a.length; i++) {
                    this.a[i] = new Item(attr.a[i], "gameBtn", false, true)
                    this.a[i].object.href = attr.a[i].a
                    this.a[i].object.target = "_blank"
                    if (attr.a[i].download) {
                        this.a[i].object.download = "眼力大考驗結果圖"
                    }
                    this.a[i].object.addEventListener("click", () => {
                    })
                    this.object.appendChild(this.a[i].object)
                }
            }
            // 創建 gameItem 
            if (attr.item) {
                this.item = []
                this.selectedItem = null //儲存用
                for (let i = 0; i < attr.item.length; i++) {
                    this.item[i] = new Item(attr.item[i], "gameItem", simplyP)
                    if (!attr.item[i].isStableItem) { //如果不是靜態物件，加入遊戲規則
                        if (this.level / 100 > 3) { //第三關新增動畫class
                            this.item[i].object.classList.add("an" + i)
                            this.item[i].object.style.animationDelay = i * 1.3 + "s"
                        }
                        this.item[i].object.addEventListener("click", () => {
                            if (this.item[i].state == 0) {
                                sound.play(0)
                                this.item[i].on()
                                if (this.level / 100 < 3) { //前兩關物件配對、最後一關找小K
                                    this.ruleCheckMatch(i)
                                } else {
                                    this.ruleFind(i, "K")
                                }
                            }
                        })
                    } else {
                        this.item[i].object.classList.add("stableItem")
                    }
                    this.object.appendChild(this.item[i].object)
                }
                container.appendChild(this.object)
            }
            // Score Bar 
            this.scoreBar = document.createElement("div")
            this.scoreBar.classList = "scoreBar"
            this.scoreBar.style.backgroundImage = "url(" + imageUrlPrefix + "bg_score.png)"
            this.object.appendChild(this.scoreBar)
            this.scoreBarNumber = document.createElement("div")
            this.scoreBarNumber.classList = "scoreBarNumber"
            this.scoreBar.appendChild(this.scoreBarNumber)

            // Time Bar
            this.timeBar = document.createElement("div")
            this.timeBar.classList = "timeBar"
            this.timeBar.style.backgroundImage = "url(" + imageUrlPrefix + "bg_time.png)"
            this.object.appendChild(this.timeBar)
            this.timeBarNumber = document.createElement("div")
            this.timeBarNumber.classList = "timeBarNumber"
            this.timeBar.appendChild(this.timeBarNumber)

            // Score Note
            this.scoreNote = document.createElement("div")
            this.scoreNote.classList = "scoreNote"
            this.object.appendChild(this.scoreNote)
            this.scoreNoteNumber = document.createElement("div")
            this.scoreNoteNumber.classList = "scoreNoteNumber"
            this.scoreNote.appendChild(this.scoreNoteNumber)

            //其他參數
            this.tag = [{ tag: 0 }, { tag: 0 }, { tag: 0 }]
            this.openTag = { tag: 0 }
        }

        ruleCheckMatch(num) {
            if (this.selectedItem != null) {
                if (this.selectedItem.type === this.item[num].type) {
                    this.addScore(1, num)
                    sound.play(1)
                    this.item[num].object.classList.add("over")
                    this.selectedItem.object.classList.add("over")
                    this.selectedItem = null
                    if (this.gameNowNum === this.gameKachiNum) {
                        this.gameOver()
                    }
                } else {
                    sound.play(2)
                    new ImgToast("x.png", 800, 2000, "scoreNo", "fade", true, [this.item[num].object.style.left, this.item[num].object.style.top])
                    setTimeout(() => {
                        this.selectedItem.off()
                        this.item[num].off()
                        this.selectedItem = null
                    }, 200)
                }
            } else {
                this.selectedItem = this.item[num]
            }
        }
        ruleFind(num, type) {
            if (this.item[num].type === type) {
                this.addScore(1, num, 4)
                this.item[num].object.classList.add("over")
                if (this.gameNowNum === this.gameKachiNum) {
                    this.gameOver()
                }
            }
        }

        addScore(num, itemNum, scoreX = 8) {
            let score = num * scoreX
            game.score = game.score + score
            this.gameNowNum = this.gameNowNum + num
            test("" + score + ", Score : " + game.score)
            game.onMask()
            this.onScoreNote(score, itemNum)
            this.reNewScore()
        }

        reNewScore() {
            this.scoreBarNumber.textContent = game.score
        }
        reNewTimeBar(time = game.time) {
            this.timeBarNumber.textContent = time
        }

        onScoreNote(score, itemNum, offTime = 1250) {
            this.scoreNote.style.display = "inline-block"
            this.scoreNote.style.left = this.item[itemNum].object.style.left
            this.scoreNote.style.top = this.item[itemNum].object.style.top
            this.scoreNote.style.opacity = 0.9
            this.scoreNoteNumber.textContent = score

            setTimeout(() => {
                this.scoreNote.style.left = "12%"
                this.scoreNote.style.top = "20%"
                this.scoreNote.style.opacity = 0
            }, 0)
            setTimeout(() => {
                this.scoreNote.style.display = "none"
            }, offTime)
        }

        gameStart(startTime = 3) {
            if (this.playingTag) {
                return test(this.level + " is playing")
            }
            test(this.level + " start")
            this.playingTag = true
            game.onMaskOn()
            this.scoreBar.classList.add("gameShow")
            this.timeBar.classList.add("gameShow")
            sound.play(4, "", 0.5)

            //開始遊戲前倒數
            this.countdownElement = document.createElement("div");
            this.countdownElementText = document.createElement("div");
            this.countdownElement.classList = "countdownElement"
            this.object.appendChild(this.countdownElement);
            this.countdownElement.appendChild(this.countdownElementText);
            this.countdownElementText.textContent = startTime - game.time;
            game.startTimer(
                1, () => {
                    this.countdownElementText.textContent = startTime - game.time;
                },
                startTime, () => {
                    //關閉倒數物件
                    this.countdownElement.style.opacity = 0
                    game.onMaskOff()
                    // setTimeout(() => this.countdownElement.remove(), 600);
                    //開始遊戲計時
                    game.startTimer(1, () => this.reNewTimeBar(this.gameFullTime - game.time), this.gameFullTime + 1,
                        () => {
                            new ImgToast("timeOut.png", 1500, 2000, "timeOut", "fade", true)
                            setTimeout(() => this.gameOver(true), 1500)
                        })
                    //播放遊戲中音樂
                    bgm[0].play("loop")
                }
            )
        }
        gameOver(isTimeOut = false) {

            overDialog[Math.floor(this.level / 100) - 1].show(isTimeOut)
            this.reset()
            test(this.level + " gameOVer")
        }
        open() {
            this.object.style.height = 100 + "%"
            this.object.style.width = 100 + "%"
            this.object.style.opacity = 1
            this.openTag = { tag: 1 }
            this.reset()
        }
        close() {
            this.object.style.height = 0 + "%"
            this.object.style.width = 0 + "%"
            this.object.style.opacity = 0
            this.openTag = { tag: 0 }
            this.reset()
        }

        reset() {
            for (let i = 0; i < this.item.length; i++) {
                this.item[i].off()
                this.item[i].object.classList.remove("over")
            }
            game.stopTimer()
            //倒數物件如果存在，刪除
            if (this.countdownElement) {
                this.countdownElement.style.opacity = ""
                this.countdownElement.remove();
            }
            this.gameNowNum = 0
            this.selectedItem = null
            this.scoreBar.classList.remove("gameShow")
            this.timeBar.classList.remove("gameShow")
            //停止所有音樂
            musicAllStop()
            this.playingTag = false
            // test(this.level + " reset")
        }
    }

    class Game {
        constructor() {
            this.nowLevel = [0, 0]
            this.score = 0
            this.time = 0
            this.scoreRange = 0
            // Mask
            this.mask = document.createElement("div")
            this.mask.classList = "mask"
            this.maskTag = 0
            container.appendChild(this.mask)
        }

        start() {
            scene[0].close()
            this.goToDetail(0)
            say[0].show()

        }
        end() {
            this.closeAllScene()
            musicAllStop()

            // loading 畫面
            new ImgToast("scorePage_loading_Bg.png", 2450, 500, "loadingPage", "fade", false, false, container, ["scorePage_loading.png", "interImg"])
            const scorePage = scene.find(p => p.level === "scorePage");
            setTimeout(() => sound.play(3), 500)

            // 選擇眼力圖 > 開啟結果頁 > 更新分數 
            const kekaNum = parseInt(this.score / 10) + 1
            let background = `scorePage_${kekaNum}`
            scorePage.object.style.backgroundImage = "url(" + imageUrlPrefix + background + ".png"
            scene[2].a[0].object.href = imageUrlPrefix + background + ".png"
            scorePage.open()
            // scorePage.scoreBar.classList.add("show")
            // scorePage.scoreBar.classList.add("scorePage")
            scorePage.scoreBar.style.backgroundImage = ""
            scorePage.reNewScore()

        }
        goHome() {
            this.closeAllScene()
            scene[0].open()
            gameLevel[this.nowLevel[0]][this.nowLevel[1]].reset()
            gameLevel[this.nowLevel[0]][this.nowLevel[1]].close()
            this.nowLevel = [0, 0]
            this.score = 0
            this.time = 0
            this.onMaskOff()
            this.stopTimer()
            scene[this.scoreRange].scoreBar.classList.remove("scorePage")
            scene[this.scoreRange].timeBar.classList.remove("scorePage")
        }
        goToDetail(num) {
            gameDetail[num].open()

            //延遲開始按鈕進場
            gameDetail[num].btn[0].object.style.opacity = 0
            gameDetail[num].btn[0].object.style.transform = "translate(-50%, -50%) scale(0.4)"
            setTimeout(() => {
                gameDetail[num].btn[0].object.style.opacity = 1
                gameDetail[num].btn[0].object.style.transform = "translate(-50%, -50%) scale(1)"
            }, 1500)
            bgm[1].play("loop")
        }
        goToLevel(num, isStartGame = false) {
            this.closeAllScene()
            const randomIndex = Math.floor(Math.random() * gameLevel[num].length);
            if (this.nowLevel != [num, randomIndex]) {
                gameLevel[this.nowLevel[0]][this.nowLevel[1]].close()
                gameLevel[num][randomIndex].open()
                gameLevel[num][randomIndex].reNewScore()
                gameLevel[num][randomIndex].reNewTimeBar(gameLevel[num][randomIndex].gameFullTime)
                game.onMaskOn(0.3)

                say[num + 1].show()


                if (isStartGame) {
                    // setTimeout 為分流不同步 reset() 中的功能( 如:停止timer )
                    setTimeout(() => { gameLevel[num][randomIndex].gameStart() }, 0)
                }
                this.nowLevel = [num, randomIndex]
                test("level now is " + this.nowLevel)
            }
        }

        closeAllScene() {
            scene.forEach(s => s.close());
            gameDetail.forEach(s => s.close());
        }



        // --------------
        // 工具
        // --------------

        startTimer(aTime = 1, act = () => console.log(this.time), stopTime = 5, stopAct = () => console.log("stop")) {
            this.timer = setInterval(() => {
                this.time = this.time + 1
                //是否到停止時間
                if (this.time == stopTime) {
                    this.stopTimer()
                    stopAct()
                } else {
                    act()
                }
            }, aTime * 1000);
        }
        stopTimer() {
            clearInterval(this.timer)
            this.time = 0
        }
        onMask(stayTime = 300, fideOutTime = 300, opacity = 0.2) {
            this.onMaskOn(opacity)
            this.maskStayTimer = setTimeout(() => {
                this.onMaskOff(fideOutTime)
            }, stayTime)
        }

        onMaskOn(opacity = 0.2) {
            setTimeout(() => {
                this.maskTag = 1
                this.mask.style.display = "inline-block"
                this.mask.style.opacity = opacity
            }, 100)
        }
        onMaskOff(fideOutTime = 300) {
            if (this.maskTag == 1) {
                this.mask.style.opacity = 0
                this.maskTimer = setTimeout(() => {
                    this.mask.style.display = "none"
                    this.maskTag = 0
                }, fideOutTime + 100)
            }
            this.maskTag = 0
        }
    }


    ///---------------------------------
    //
    //
    //      創建
    //
    //
    ///---------------------------------


    // ---------------------
    //
    // 創建聲音
    //
    // ---------------------
    var audioList = [
        imageUrlPrefix + "ui_02.mp3",
        imageUrlPrefix + "01_addScore.mp3",
        imageUrlPrefix + "02_noScore.mp3",
        imageUrlPrefix + "03_scoreWait.mp3",
        imageUrlPrefix + "04_count.mp3",
    ];


    var sound = new Sound(audioList)
    var bgmList = [
        { voice: imageUrlPrefix + "001.mp3" },
        { voice: imageUrlPrefix + "002.mp3" },
        { voice: imageUrlPrefix + "K-1.mp3" },
        { voice: imageUrlPrefix + "K-2.mp3" },
        { voice: imageUrlPrefix + "K-3.mp3" },
        { voice: imageUrlPrefix + "K-4.mp3" },
        { voice: imageUrlPrefix + "K-5.mp3" },
    ]
    var bgm = bgmList.map((item) => {
        let musicInstance = new music(item.voice);
        return musicInstance;
    });




    bgm[0].gainNode.gain.value = 0.5
    bgm[1].gainNode.gain.value = 0.5
    bgm[2].gainNode.gain.value = 2.5
    bgm[3].gainNode.gain.value = 2.5
    bgm[4].gainNode.gain.value = 2.5
    bgm[5].gainNode.gain.value = 2.5
    bgm[6].gainNode.gain.value = 2.5




    // Mute 功能
    muteTag = { tag: 1 }
    mute = () => {
        toggle(muteTag, () => {
            mainGainNode.gain.value = 1
            for (let i = 0; i < gameLevel.length; i++) {
                for (let j = 0; j < gameLevel[i].length; j++) {
                    gameLevel[i][j].btn[0].object.style.opacity = 1;
                }
            }
            for (let j = 0; j < gameDetail.length; j++) {
                gameDetail[j].btn[1].object.style.opacity = 1;
            }
            scene[0].btn[2].object.style.opacity = 1
        }, () => {
            mainGainNode.gain.value = 0
            for (let i = 0; i < gameLevel.length; i++) {
                for (let j = 0; j < gameLevel[i].length; j++) {
                    gameLevel[i][j].btn[0].object.style.opacity = 0.5;
                }
            }
            for (let j = 0; j < gameDetail.length; j++) {
                gameDetail[j].btn[1].object.style.opacity = 0.5;
            }
            scene[0].btn[2].object.style.opacity = 0.5
        })
    }




    // ---------------------
    //
    // 創建遊戲場景
    //
    // ---------------------

    gameHeaderBtns = [
        { size: [8, 8], xyr: [70, 6.5, 0], background: "btn_Mute.png", act: () => mute(), color: "" },
        { size: [8, 8], xyr: [80, 6.5, 0], background: "btn_Home.png", act: () => game.goHome(), color: "" },
        { size: [8, 8], xyr: [90, 6.5, 0], background: "btn_next.png", act: () => gameLevel[game.nowLevel[0]][game.nowLevel[1]].gameOver(), color: "" },
    ]
    gameLevelAttr = [
        [{
            level: 101, background: "level01_Bg.png", gameTime: 10, gameKachiNum: 5,
            item: [
                { type: "L101", size: [166, 90], xyr: [101, 726, 0], background: "L1-1_item01.png", isStableItem: false, color: "" },
                { type: "L101", size: [218, 207], xyr: [653, 431, 0], background: "L1-1_item02.png", isStableItem: false, color: "" },
                { type: "L103", size: [123, 125], xyr: [184, 874, 0], background: "L1-1_item03.png", isStableItem: false, color: "" },
                { type: "L103", size: [177, 180], xyr: [578, 1273, 0], background: "L1-1_item04.png", isStableItem: false, color: "" },
                { type: "L105", size: [93, 94], xyr: [362, 895, 0], background: "L1-1_item05.png", isStableItem: false, color: "" },
                { type: "L105", size: [120, 120], xyr: [53, 1042, 0], background: "L1-1_item06.png", isStableItem: false, color: "" },
                { type: "L107", size: [128, 56], xyr: [78, 951, 0], background: "L1-1_item07.png", isStableItem: false, color: "" },
                { type: "L107", size: [221, 136], xyr: [730, 1314, 0], background: "L1-1_item08.png", isStableItem: false, color: "" },
                { type: "L109", size: [112, 112], xyr: [343, 1042, 0], background: "L1-1_item09.png", isStableItem: false, color: "" },
                { type: "L109", size: [184, 184], xyr: [92, 1284, 0], background: "L1-1_item10.png", isStableItem: false, color: "" },

                { type: "B", size: [947, 389], xyr: [41, 1364, 0], background: "l1_itemS01.png", isStableItem: true, color: "" },
            ], btn: gameHeaderBtns
        }, {
            level: 102, background: "level01_Bg.png", gameTime: 10, gameKachiNum: 5,
            item: [
                { type: "L101", size: [87, 88], xyr: [392, 900, 0], background: "L1-2_item01.png", isStableItem: false, color: "" },
                { type: "L101", size: [181, 184], xyr: [202, 1288, 0], background: "L1-2_item02.png", isStableItem: false, color: "" },
                { type: "L103", size: [212, 130], xyr: [202, 458, 0], background: "L1-2_item03.png", isStableItem: false, color: "" },
                { type: "L103", size: [220, 136], xyr: [327, 1336, 0], background: "L1-2_item04.png", isStableItem: false, color: "" },
                { type: "L105", size: [103, 104], xyr: [79, 899, 0], background: "L1-2_item05.png", isStableItem: false, color: "" },
                { type: "L105", size: [192, 194], xyr: [579, 947, 0], background: "L1-2_item06.png", isStableItem: false, color: "" },
                { type: "L107", size: [74, 76], xyr: [202, 927, 0], background: "L1-2_item07.png", isStableItem: false, color: "" },
                { type: "L107", size: [244, 243], xyr: [612, 1208, 0], background: "L1-2_item08.png", isStableItem: false, color: "" },
                { type: "L109", size: [166, 90], xyr: [734, 768, 0], background: "L1-2_item09.png", isStableItem: false, color: "" },
                { type: "L109", size: [107, 88], xyr: [318, 1077, 0], background: "L1-2_item10.png", isStableItem: false, color: "" },

                { type: "B", size: [947, 389], xyr: [41, 1364, 0], background: "l1_itemS01.png", isStableItem: true, color: "" },
            ], btn: gameHeaderBtns
        },], [{
            level: 201, background: "level02_Bg.png", gameTime: 10, gameKachiNum: 5,
            item: [
                { type: "L201", size: [97, 53], xyr: [842, 621, 0], background: "L2-1_item01.png", isStableItem: false, color: "" },
                { type: "L201", size: [92, 105], xyr: [47, 552, 0], background: "L2-1_item02.png", isStableItem: false, color: "" },
                { type: "L203", size: [229, 167], xyr: [654, 694, 0], background: "L2-1_item03.png", isStableItem: false, color: "" },
                { type: "L203", size: [75, 75], xyr: [425, 1433, 0], background: "L2-1_item04.png", isStableItem: false, color: "" },
                { type: "L205", size: [169, 143], xyr: [708, 1003, 0], background: "L2-1_item05.png", isStableItem: false, color: "" },
                { type: "L205", size: [31, 37], xyr: [340, 816, 0], background: "L2-1_item06.png", isStableItem: false, color: "" },
                { type: "L207", size: [152, 128], xyr: [57, 1052, 0], background: "L2-1_item07.png", isStableItem: false, color: "" },
                { type: "L207", size: [43, 35], xyr: [196, 986, 0], background: "L2-1_item08.png", isStableItem: false, color: "" },
                { type: "L209", size: [220, 164], xyr: [60, 1427, 0], background: "L2-1_item09.png", isStableItem: false, color: "" },
                { type: "L209", size: [103, 146], xyr: [877, 1134, 0], background: "L2-1_item10.png", isStableItem: false, color: "" },
            ], btn: gameHeaderBtns
        }, {
            level: 202, background: "level02_Bg.png", gameTime: 10, gameKachiNum: 5,
            item: [
                { type: "L201", size: [220, 160], xyr: [541, 422, 0], background: "L2-2_item01.png", isStableItem: false, color: "" },
                { type: "L201", size: [65, 53], xyr: [717, 992, 0], background: "L2-2_item02.png", isStableItem: false, color: "" },
                { type: "L203", size: [97, 105], xyr: [883, 611, 0], background: "L2-2_item03.png", isStableItem: false, color: "" },
                { type: "L203", size: [97, 55], xyr: [415, 1192, 0], background: "L2-2_item04.png", isStableItem: false, color: "" },
                { type: "L205", size: [103, 146], xyr: [877, 1134, 0], background: "L2-2_item05.png", isStableItem: false, color: "" },
                { type: "L205", size: [114, 155], xyr: [48, 1094, 0], background: "L2-2_item06.png", isStableItem: false, color: "" },
                { type: "L207", size: [169, 143], xyr: [225, 774, 0], background: "L2-2_item07.png", isStableItem: false, color: "" },
                { type: "L207", size: [31, 37], xyr: [60, 765, 0], background: "L2-2_item08.png", isStableItem: false, color: "" },
                { type: "L209", size: [152, 128], xyr: [680, 1464, 0], background: "L2-2_item09.png", isStableItem: false, color: "" },
                { type: "L209", size: [43, 45], xyr: [151, 852, 0], background: "L2-2_item10.png", isStableItem: false, color: "" },
            ], btn: gameHeaderBtns
        },], [{
            level: 301, background: "level03_Bg.png", gameTime: 10, gameKachiNum: 5,
            item: [
                { type: "K", size: [115, 100], xyr: [450, 410, 0], background: "L3_item01.png", isStableItem: false, color: "" },
                { type: "S", size: [188, 188], xyr: [379, 428, 0], background: "L3_itemS01.png", isStableItem: true, color: "" },
                { type: "K", size: [174, 172], xyr: [560, 1015, 0], background: "L3_item02.png", isStableItem: false, color: "" },
                { type: "S", size: [183, 172], xyr: [573, 1000, 0], background: "L3_itemS02.png", isStableItem: true, color: "" },
                { type: "K", size: [100, 100], xyr: [283, 1035, 0], background: "L3_item03.png", isStableItem: false, color: "" },
                { type: "S", size: [224, 209], xyr: [242, 959, 0], background: "L3_itemS03.png", isStableItem: true, color: "" },
                { type: "K", size: [90, 90], xyr: [875, 1200, 0], background: "L3_item04.png", isStableItem: false, color: "" },
                { type: "S", size: [350, 287], xyr: [706, 1136, 0], background: "L3_itemS04.png", isStableItem: true, color: "" },
                { type: "K", size: [150, 163], xyr: [80, 1200, 0], background: "L3_item05.png", isStableItem: false, color: "" },
                { type: "S", size: [182, 308], xyr: [48, 1117, 0], background: "L3_itemS05.png", isStableItem: true, color: "" },
                { type: "S", size: [112, 145], xyr: [585, 1590, 0], background: "L3_itemS06.png", isStableItem: true, color: "" },

            ], btn: gameHeaderBtns
        }]
    ]

    gameDetailAttr = [{
        level: "L1 detail", background: "level01d_Bg.png", item: [], gameTime: 0, gameKachiNum: 0,
        btn: [{ name: "start", size: [44, 28], xyr: [50, 45, 0], act: () => game.goToLevel(0), background: "btn_start.png", color: "" },
        { size: [8, 8], xyr: [90, 6.5, 0], background: "btn_Mute.png", act: () => mute(), color: "" },]
    }, {
        level: "L2 detail", background: "level02d_Bg.png", item: [], gameTime: 0, gameKachiNum: 0,
        btn: [{ name: "start", size: [44, 28], xyr: [50, 45, 0], act: () => game.goToLevel(1), background: "btn_start.png", color: "" },
        { size: [8, 8], xyr: [90, 6.5, 0], background: "btn_Mute.png", act: () => mute(), color: "" },]
    }, {
        level: "L3 detail", background: "level03d_Bg.png", item: [], gameTime: 0, gameKachiNum: 0,
        btn: [{ name: "start", size: [44, 28], xyr: [50, 60, 0], act: () => game.goToLevel(2), background: "btn_start.png", color: "" },
        { size: [8, 8], xyr: [90, 6.5, 0], background: "btn_Mute.png", act: () => mute(), color: "" },]
    },]



    var shareLink = [
        "https://www.facebook.com/sharer.php?u＝網址",
        "program/kvm_game/"
    ]
    sceneAttr = [
        {
            level: "home", background: "home_bg.png",
            btn: [
                { name: "start", size: [44, 28], xyr: [50, 45, 0], background: "btn_start.png", act: () => game.start(), color: "" },
                { name: "kCyan", size: [80, 75], xyr: [70, 85, 0], background: "home_k.png", act: () => sound.play(1), color: "" },
                { name: "mute", size: [10, 10], xyr: [10, 5, 0], background: "btn_Mute.png", act: () => mute(), color: "" }
            ], item: [], gameTime: 0, gameKachiNum: 0
        }, {
            level: "setumei", background: "ls_Bg.png",
            btn: [
                { name: "Next", size: [80, 50], xyr: [61, 40, 0], background: "btn_gotoEnd.png", act: () => game.end(), color: "" },
            ], item: [], gameTime: 0, gameKachiNum: 0
        }, {
            level: "scorePage", background: "",
            btn: [
                { name: "reStart", size: [0, 0], xyr: [25, 24.5, 0], background: "scorePBtn01.png", act: () => game.goHome(), color: "" },
            ], a: [
                { name: "download", size: [31, 13], xyr: [32, 87, 0], background: "scorePBtn02.png", a: "#", download: false, act: nothing, color: "" },
                { name: "link    ", size: [31, 13], xyr: [66, 87, 0], background: "scorePBtn03.png", a: "#", download: false, act: nothing, color: "" },
                { name: "link    ", size: [32, 5.5], xyr: [64.8, 66.1, 0], background: "scorePBtn04.png", a: "#", download: false, act: nothing, color: "" },
            ], item: [], gameTime: 0, gameKachiNum: 0
        }
    ]




    container = $css("gameContainer")[0]
    game = new Game()
    gameLevel = []
    for (let i = 0; i < gameLevelAttr.length; i++) {
        gameLevel[i] = Array.from({ length: gameLevelAttr[i].length }, (_, j) => new GameScene(gameLevelAttr[i][j], true))
    }
    var gameDetail = Array.from({ length: gameDetailAttr.length }, (_, i) => new GameScene(gameDetailAttr[i]))
    var scene = Array.from({ length: sceneAttr.length }, (_, i) => new GameScene(sceneAttr[i]))





    // ---------------------
    //
    // 創建對話視窗
    //
    // ---------------------

    var overDAttr = [{
        name: "L1",
        h: "<span>恭喜你全都找到了！<br></span>前往下一關繼續挑戰吧～",
        timeout: "<span>時間到囉！</span><br>下一關我們繼續加油～",
        c: "你的分數是: ",
        btn: [{ t: "下一關", a: () => { game.goToDetail(1); overDialog[0].remove() } }]
    }, {
        name: "L2",
        h: "<span>恭喜你全都找到了！<br></span>前往下一關繼續挑戰吧～",
        timeout: "<span>時間到囉！</span><br>下一關我們繼續加油～",
        c: "你的分數是: ",
        btn: [{ t: "下一關", a: () => { game.goToDetail(2); overDialog[1].remove() } }]
    }, {
        name: "L3",
        h: "<span>恭喜你全都找到了！</span>恭喜你完成眼力大考驗！",
        timeout: "<span>時間到囉！</span><br>恭喜你完成眼力大考驗！",
        c: "你的分數是: ",
        btn: [{
            t: "產生眼力分數", a: () => {
                scene[1].open();
                //延遲按鈕進場
                scene[1].btn[0].object.style.opacity = 0
                scene[1].btn[0].object.style.transform = "translate(-50%, -50%) scale(0.2)"
                say[4].show();
                overDialog[2].remove();
                bgm[1].play("loop")
            }
        }]
    },]



    var gameStartNow = () => {
        gameLevel[game.nowLevel[0]][game.nowLevel[1]].gameStart()
    }
    var showGoToEndBtn = () => {
        scene[1].btn[0].object.style.opacity = 1
        scene[1].btn[0].object.style.transform = "translate(-50%, -50%) scale(1)"
    }


    var sayAttr = [
        { name: "", voice: 2, t: 2000, act: nothing, bg: "faceK01.png", c: "Let me see see 你的眼力多好！" },
        { name: "", voice: 3, t: 2000, act: gameStartNow, bg: "faceK02.png", c: "記得連續點擊你看到的兩個相同的電腦，點擊正確才會算分喔！" },
        { name: "", voice: 4, t: 2000, act: gameStartNow, bg: "faceK03.png", c: "連續點擊一對的鍵盤和滑鼠，把你的桌面恢復乾淨吧！" },
        { name: "", voice: 5, t: 2000, act: gameStartNow, bg: "faceK04.png", c: "快來找我! 快看看我在哪" },
        { name: "", voice: 6, t: 2600, act: showGoToEndBtn, bg: "faceK05.png", c: "有了偶，就只需要用一組鍵盤滑鼠和一個螢幕就可以輕鬆在兩台電腦中切換，真是天下無敵方便呀！" },
    ]

    const overDialog = Array.from({ length: overDAttr.length }, (_, i) => new Dialog(overDAttr[i].h, overDAttr[i].c, overDAttr[i].btn, overDAttr[i].timeout))
    const say = Array.from({ length: sayAttr.length }, (_, i) => new Say(sayAttr[i].c, sayAttr[i].bg, "Skip", sayAttr[i].t, sayAttr[i].voice, sayAttr[i].act))




    ///---------------------------------
    //
    //
    //      入場動作
    //
    //
    ///---------------------------------

    // 入場 Mask

    openMask = $css("openMask")[0]
    startBtn = $css("startBtn")[0]

    window.onload = () => {
        scene[0].btn[0].object.style.transform = "translate(-50%, -50%) scale(1.4)"
        scene[0].btn[1].object.style.transform = "translate(20%, 20%) scale(0.8) rotate(16deg)"
        scene[0].btn[0].object.classList = ("gameBtn home Fade")
        scene[0].btn[1].object.classList = ("gameBtn home Fade")

        openMask.style.opacity = 0.98
        startBtn.style.opacity = 1
        openMask.addEventListener("click", () => {
            openMask.style.opacity = 0
            setTimeout(() => openMask.remove(), 2000)
            setTimeout(() => {
                scene[0].btn[1].object.classList.remove("Fade")
                scene[0].btn[1].object.style.transform = "translate(-50%, -50%)"
            }, 500)
            setTimeout(() => {
                scene[0].btn[0].object.classList.remove("Fade")
                scene[0].btn[0].object.style.transform = "translate(-50%, -50%)"
            }, 1500)

            var bgmList = [
                { voice: imageUrlPrefix + "001.mp3" },
                { voice: imageUrlPrefix + "002.mp3" },
                { voice: imageUrlPrefix + "K-1.mp3" },
                { voice: imageUrlPrefix + "K-2.mp3" },
                { voice: imageUrlPrefix + "K-3.mp3" },
                { voice: imageUrlPrefix + "K-4.mp3" },
                { voice: imageUrlPrefix + "K-5.mp3" },
            ]
            var bgm = bgmList.map((item) => {
                let musicInstance = new music(item.voice);
                return musicInstance;
            });
            bgm[0].gainNode.gain.value = 0.3
            bgm[1].gainNode.gain.value = 0.3
            bgm[2].gainNode.gain.value = 2.5
            bgm[3].gainNode.gain.value = 2.5
            bgm[4].gainNode.gain.value = 2.5
            bgm[5].gainNode.gain.value = 2.5
            bgm[6].gainNode.gain.value = 2.5

            setTimeout(() => {
                bgm[0].voice = document.createElement("audio")
                bgm[0].voice.src = imageUrlPrefix + "002.mp3"
                bgm[0].gainNode.gain.value = 0.3
            }, 100)

        })

    }



    // 入場 Mask 關閉 測試用
    // openMask.style.opacity = 0
    // setTimeout(() => openMask.remove(), 500)


    //啟動音樂
    openCtx(openMask)
    openCtx(scene[0].btn[0].object)

    //入場先讀取圖
    var imagePreLoad = []
    var imagePreLoadUrl = [
        imageUrlPrefix + "scorePage_loading_Bg.png",
        imageUrlPrefix + "scorePage_0.png",
        imageUrlPrefix + "scorePage_1.png",
        imageUrlPrefix + "scorePage_2.png",
        imageUrlPrefix + "scorePage_3.png",
        imageUrlPrefix + "scorePage_4.png",
        imageUrlPrefix + "scorePage_5.png",
        imageUrlPrefix + "scorePage_6.png",
        imageUrlPrefix + "scorePage_7.png",
        imageUrlPrefix + "scorePage_8.png",
        imageUrlPrefix + "scorePage_9.png",
        imageUrlPrefix + "scorePage_10.png",
    ]
    for (let i = 0; i < imagePreLoadUrl.length; i++) {
        imagePreLoad[i] = document.createElement("img")
        imagePreLoad[i].src = imagePreLoadUrl[i]
        imagePreLoad[i].style.opacity = 1
        imagePreLoad[i].style.height = 0
        imagePreLoad[i].style.position = "absolute"
        imagePreLoad[i].style.top = 0
        container.appendChild(imagePreLoad[i])
        setTimeout(() => { imagePreLoad[i].remove() }, 10)
    }






    // gameLevel[0][0].open()
    // gameLevel[2][0].open()

    // gameLevel[1][0].reNewScore()
    // gameLevel[1][0].reNewTimeBar(30)
    game.goHome()
    // game.end()
    // game.goToLevel(0)
    // scene[1].open()


    // game.goToDetail(2)




    ///---------------------------------
    //
    //
    //      互動
    //
    //
    ///---------------------------------

    window.addEventListener("keydown", keyboardListener, false);

    function keyboardListener(e) {
        var keyID = e.code;
        if (keyID === 'KeyQ') {
            // gameLevel[0].opentaggle()
            // game.start()
            // game.startTimer()

            gameLevel[0][0].gameStart()
        }

        if (keyID === 'KeyA') {
            gameLevel[0][0].reset()

        }
        if (keyID === 'KeyZ') {
            game.stopTimer()
        }

        if (keyID === 'KeyW') {
            new ImgToast("timeOut.png", 1500, 2000, "timeOut", "fade", true)
        }
        if (keyID === 'KeyS') {

        }
        if (keyID === 'KeyX') {

        }
        if (keyID === 'KeyE') {

        }


        if (keyID === 'KeyH') {
            game.goHome()
        }

        if (keyID === 'KeyC') {
            say[4].show()
            // new ImgToast("l1_item07.png")
        }

    }


    // const hash = window.location.hash;
    // console.log('Hash:', hash);

</script>

</html>